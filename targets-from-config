#!/usr/bin/env python
from itertools import tee, izip
import os.path
import sys

filename = sys.argv[1]
dirname = sys.argv[2]
with open(filename) as f:
    content = f.readlines()

filenames = [x.strip('\n') for x in content]


def pairwise(iterable):
    a, b = tee(iterable)
    next(b, None)
    return izip(a, b)


def get_name(x, y):
    xname, _ = os.path.splitext(x)
    yname, _ = os.path.splitext(y)
    return xname + "-" + yname


def print_crop_target(x):
    print """\
$(CROP_DIR)/%(x)s: $(LASFILE_DIR)/%(x)s | $(CROP_DIR) pdal
\t$(PDAL_EXE) translate -i $< -o $@ --bounds $(BOUNDS) 2> >(tee $(@:%%.las=%%.log) >&2)""" % locals()
    return "$(CROP_DIR)/%s" % x


def print_change_target(x, y):
    name = get_name(x, y)
    print """\
$(CHANGE_DIR)/%(name)s.txt: $(LASFILE_DIR)/%(x)s $(LASFILE_DIR)/%(y)s $(CONFIG_FILE)| $(CHANGE_DIR) pdal
\t$(PDAL_EXE) cpd -x $(firstword $^) -y $(word 2,$^) -o $@ $(PDAL_CPD_ARGS) 2> >(tee $(@:%%.txt=%%.log) >&2)""" % locals()
    return "$(CHANGE_DIR)/%s.txt" % name


def print_magnitude_target(x, y):
    name = get_name(x, y)
    print """\
$(MAGNITUDE_DIR)/%(name)s.png: $(CHANGE_DIR)/%(name)s.txt $(MAGNITUDE_SCRIPT) $(CONFIG_FILE) | $(MAGNITUDE_DIR)
\trscript $(MAGNITUDE_SCRIPT) $< $@ $(MINMAGNITUDE) $(MAXMAGNITUDE)"""  % locals()
    return "$(MAGNITUDE_DIR)/%s.png" % name


def print_toplevel_target(name, targets):
    print "%s: %s\n.PHONY: %s" % (name, ' '.join(targets), name)


print "# This file is autogenerated by targets-from-config, do not edit"

crop_targets = []
change_targets = []
magnitude_targets = []

for x in filenames:
    crop_targets += [print_crop_target(x)]

for x, y in pairwise(filenames):
    change_targets += [print_change_target(x, y)]
    magnitude_targets += [print_magnitude_target(x, y)]

print_toplevel_target("crop", crop_targets)
print_toplevel_target("change", change_targets)
print_toplevel_target("magnitude", magnitude_targets)
